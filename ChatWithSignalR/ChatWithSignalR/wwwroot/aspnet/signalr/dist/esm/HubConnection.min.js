/**
 * Minified by jsDelivr using Terser v5.3.5.
 * Original file: /npm/@aspnet/signalr@1.0.27/dist/esm/HubConnection.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
var __awaiter=this&&this.__awaiter||function(e,t,o,n){return new(o||(o=Promise))((function(r,i){function s(e){try{c(n.next(e))}catch(e){i(e)}}function a(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){e.done?r(e.value):new o((function(t){t(e.value)})).then(s,a)}c((n=n.apply(e,t||[])).next())}))},__generator=this&&this.__generator||function(e,t){var o,n,r,i,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(o)throw new TypeError("Generator is already executing.");for(;s;)try{if(o=1,n&&(r=2&i[0]?n.return:i[0]?n.throw||((r=n.return)&&r.call(n),0):n.next)&&!(r=r.call(n,i[1])).done)return r;switch(n=0,r&&(i=[2&i[0],r.value]),i[0]){case 0:case 1:r=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,n=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(r=s.trys,(r=r.length>0&&r[r.length-1])||6!==i[0]&&2!==i[0])){s=0;continue}if(3===i[0]&&(!r||i[1]>r[0]&&i[1]<r[3])){s.label=i[1];break}if(6===i[0]&&s.label<r[1]){s.label=r[1],r=i;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(i);break}r[2]&&s.ops.pop(),s.trys.pop();continue}i=t.call(e,s)}catch(e){i=[6,e],n=0}finally{o=r=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}};import{HandshakeProtocol}from"./HandshakeProtocol";import{MessageType}from"./IHubProtocol";import{LogLevel}from"./ILogger";import{Arg,Subject}from"./Utils";var DEFAULT_TIMEOUT_IN_MS=3e4,HubConnection=function(){function e(e,t,o){var n=this;Arg.isRequired(e,"connection"),Arg.isRequired(t,"logger"),Arg.isRequired(o,"protocol"),this.serverTimeoutInMilliseconds=DEFAULT_TIMEOUT_IN_MS,this.logger=t,this.protocol=o,this.connection=e,this.handshakeProtocol=new HandshakeProtocol,this.connection.onreceive=function(e){return n.processIncomingData(e)},this.connection.onclose=function(e){return n.connectionClosed(e)},this.callbacks={},this.methods={},this.closedCallbacks=[],this.id=0}return e.create=function(t,o,n){return new e(t,o,n)},e.prototype.start=function(){return __awaiter(this,void 0,void 0,(function(){var e;return __generator(this,(function(t){switch(t.label){case 0:return e={protocol:this.protocol.name,version:this.protocol.version},this.logger.log(LogLevel.Debug,"Starting HubConnection."),this.receivedHandshakeResponse=!1,[4,this.connection.start(this.protocol.transferFormat)];case 1:return t.sent(),this.logger.log(LogLevel.Debug,"Sending handshake request."),[4,this.connection.send(this.handshakeProtocol.writeHandshakeRequest(e))];case 2:return t.sent(),this.logger.log(LogLevel.Information,"Using HubProtocol '"+this.protocol.name+"'."),this.cleanupTimeout(),this.configureTimeout(),[2]}}))}))},e.prototype.stop=function(){return this.logger.log(LogLevel.Debug,"Stopping HubConnection."),this.cleanupTimeout(),this.connection.stop()},e.prototype.stream=function(e){for(var t=this,o=[],n=1;n<arguments.length;n++)o[n-1]=arguments[n];var r=this.createStreamInvocation(e,o),i=new Subject((function(){var e=t.createCancelInvocation(r.invocationId),o=t.protocol.writeMessage(e);return delete t.callbacks[r.invocationId],t.connection.send(o)}));this.callbacks[r.invocationId]=function(e,t){t?i.error(t):e.type===MessageType.Completion?e.error?i.error(new Error(e.error)):i.complete():i.next(e.item)};var s=this.protocol.writeMessage(r);return this.connection.send(s).catch((function(e){i.error(e),delete t.callbacks[r.invocationId]})),i},e.prototype.send=function(e){for(var t=[],o=1;o<arguments.length;o++)t[o-1]=arguments[o];var n=this.createInvocation(e,t,!0),r=this.protocol.writeMessage(n);return this.connection.send(r)},e.prototype.invoke=function(e){for(var t=this,o=[],n=1;n<arguments.length;n++)o[n-1]=arguments[n];var r=this.createInvocation(e,o,!1),i=new Promise((function(e,o){t.callbacks[r.invocationId]=function(t,n){if(n)o(n);else if(t.type===MessageType.Completion){var r=t;r.error?o(new Error(r.error)):e(r.result)}else o(new Error("Unexpected message type: "+t.type))};var n=t.protocol.writeMessage(r);t.connection.send(n).catch((function(e){o(e),delete t.callbacks[r.invocationId]}))}));return i},e.prototype.on=function(e,t){e&&t&&(e=e.toLowerCase(),this.methods[e]||(this.methods[e]=[]),-1===this.methods[e].indexOf(t)&&this.methods[e].push(t))},e.prototype.off=function(e,t){if(e){e=e.toLowerCase();var o=this.methods[e];if(o)if(t){var n=o.indexOf(t);-1!==n&&(o.splice(n,1),0===o.length&&delete this.methods[e])}else delete this.methods[e]}},e.prototype.onclose=function(e){e&&this.closedCallbacks.push(e)},e.prototype.processIncomingData=function(e){if(this.cleanupTimeout(),this.receivedHandshakeResponse||(e=this.processHandshakeResponse(e),this.receivedHandshakeResponse=!0),e)for(var t=0,o=this.protocol.parseMessages(e,this.logger);t<o.length;t++){var n=o[t];switch(n.type){case MessageType.Invocation:this.invokeClientMethod(n);break;case MessageType.StreamItem:case MessageType.Completion:var r=this.callbacks[n.invocationId];null!=r&&(n.type===MessageType.Completion&&delete this.callbacks[n.invocationId],r(n));break;case MessageType.Ping:break;case MessageType.Close:this.logger.log(LogLevel.Information,"Close message received from server."),this.connection.stop(n.error?new Error("Server returned an error on close: "+n.error):null);break;default:this.logger.log(LogLevel.Warning,"Invalid message type: "+n.type)}}this.configureTimeout()},e.prototype.processHandshakeResponse=function(e){var t,o,n;try{n=(t=this.handshakeProtocol.parseHandshakeResponse(e))[0],o=t[1]}catch(e){var r="Error parsing handshake response: "+e;this.logger.log(LogLevel.Error,r);var i=new Error(r);throw this.connection.stop(i),i}if(o.error){r="Server returned handshake error: "+o.error;this.logger.log(LogLevel.Error,r),this.connection.stop(new Error(r))}else this.logger.log(LogLevel.Debug,"Server handshake complete.");return n},e.prototype.configureTimeout=function(){var e=this;this.connection.features&&this.connection.features.inherentKeepAlive||(this.timeoutHandle=setTimeout((function(){return e.serverTimeout()}),this.serverTimeoutInMilliseconds))},e.prototype.serverTimeout=function(){this.connection.stop(new Error("Server timeout elapsed without receiving a message from the server."))},e.prototype.invokeClientMethod=function(e){var t=this,o=this.methods[e.target.toLowerCase()];if(o){if(o.forEach((function(o){return o.apply(t,e.arguments)})),e.invocationId){var n="Server requested a response, which is not supported in this version of the client.";this.logger.log(LogLevel.Error,n),this.connection.stop(new Error(n))}}else this.logger.log(LogLevel.Warning,"No client method with the name '"+e.target+"' found.")},e.prototype.connectionClosed=function(e){var t=this,o=this.callbacks;this.callbacks={},Object.keys(o).forEach((function(t){(0,o[t])(void 0,e||new Error("Invocation canceled due to connection being closed."))})),this.cleanupTimeout(),this.closedCallbacks.forEach((function(o){return o.apply(t,[e])}))},e.prototype.cleanupTimeout=function(){this.timeoutHandle&&clearTimeout(this.timeoutHandle)},e.prototype.createInvocation=function(e,t,o){if(o)return{arguments:t,target:e,type:MessageType.Invocation};var n=this.id;return this.id++,{arguments:t,invocationId:n.toString(),target:e,type:MessageType.Invocation}},e.prototype.createStreamInvocation=function(e,t){var o=this.id;return this.id++,{arguments:t,invocationId:o.toString(),target:e,type:MessageType.StreamInvocation}},e.prototype.createCancelInvocation=function(e){return{invocationId:e,type:MessageType.CancelInvocation}},e}();export{HubConnection};
//# sourceMappingURL=/sm/4cbd93bf16b81ad41e1866f17bf6a2c45176596511e1972c869105d26dd3a493.map