/**
 * Minified by jsDelivr using Terser v5.3.5.
 * Original file: /npm/@aspnet/signalr@1.0.27/dist/esm/HttpConnection.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
var __awaiter=this&&this.__awaiter||function(t,e,n,r){return new(n||(n=Promise))((function(o,s){function i(t){try{c(r.next(t))}catch(t){s(t)}}function a(t){try{c(r.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new n((function(e){e(t.value)})).then(i,a)}c((r=r.apply(t,e||[])).next())}))},__generator=this&&this.__generator||function(t,e){var n,r,o,s,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(s){return function(a){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;i;)try{if(n=1,r&&(o=2&s[0]?r.return:s[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,s[1])).done)return o;switch(r=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return i.label++,{value:s[1],done:!1};case 5:i.label++,r=s[1],s=[0];continue;case 7:s=i.ops.pop(),i.trys.pop();continue;default:if(!(o=i.trys,(o=o.length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){i=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){i.label=s[1];break}if(6===s[0]&&i.label<o[1]){i.label=o[1],o=s;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(s);break}o[2]&&i.ops.pop(),i.trys.pop();continue}s=e.call(t,i)}catch(t){s=[6,t],r=0}finally{n=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}};import{DefaultHttpClient}from"./HttpClient";import{LogLevel}from"./ILogger";import{HttpTransportType,TransferFormat}from"./ITransport";import{LongPollingTransport}from"./LongPollingTransport";import{ServerSentEventsTransport}from"./ServerSentEventsTransport";import{Arg,createLogger}from"./Utils";import{WebSocketTransport}from"./WebSocketTransport";var MAX_REDIRECTS=100,HttpConnection=function(){function t(t,e){void 0===e&&(e={}),this.features={},Arg.isRequired(t,"url"),this.logger=createLogger(e.logger),this.baseUrl=this.resolveUrl(t),(e=e||{}).accessTokenFactory=e.accessTokenFactory||function(){return null},e.logMessageContent=e.logMessageContent||!1,this.httpClient=e.httpClient||new DefaultHttpClient(this.logger),this.connectionState=2,this.options=e}return t.prototype.start=function(t){return t=t||TransferFormat.Binary,Arg.isIn(t,TransferFormat,"transferFormat"),this.logger.log(LogLevel.Debug,"Starting connection with transfer format '"+TransferFormat[t]+"'."),2!==this.connectionState?Promise.reject(new Error("Cannot start a connection that is not in the 'Disconnected' state.")):(this.connectionState=0,this.startPromise=this.startInternal(t),this.startPromise)},t.prototype.send=function(t){if(1!==this.connectionState)throw new Error("Cannot send data if the connection is not in the 'Connected' State.");return this.transport.send(t)},t.prototype.stop=function(t){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(e){switch(e.label){case 0:this.connectionState=2,e.label=1;case 1:return e.trys.push([1,3,,4]),[4,this.startPromise];case 2:return e.sent(),[3,4];case 3:return e.sent(),[3,4];case 4:return this.transport?(this.stopError=t,[4,this.transport.stop()]):[3,6];case 5:e.sent(),this.transport=null,e.label=6;case 6:return[2]}}))}))},t.prototype.startInternal=function(t){return __awaiter(this,void 0,void 0,(function(){var e,n,r,o,s,i,a,c=this;return __generator(this,(function(l){switch(l.label){case 0:e=this.baseUrl,this.accessTokenFactory=this.options.accessTokenFactory,l.label=1;case 1:return l.trys.push([1,12,,13]),this.options.skipNegotiation?this.options.transport!==HttpTransportType.WebSockets?[3,3]:(this.transport=this.constructTransport(HttpTransportType.WebSockets),[4,this.transport.connect(e,t)]):[3,5];case 2:return l.sent(),[3,4];case 3:throw Error("Negotiation can only be skipped when using the WebSocket transport directly.");case 4:return[3,11];case 5:n=null,r=0,o=function(){var t;return __generator(this,(function(o){switch(o.label){case 0:return[4,s.getNegotiationResponse(e)];case 1:return n=o.sent(),2===s.connectionState?[2,{value:void 0}]:(n.url&&(e=n.url),n.accessToken&&(t=n.accessToken,s.accessTokenFactory=function(){return t}),r++,[2])}}))},s=this,l.label=6;case 6:return[5,o()];case 7:if("object"==typeof(i=l.sent()))return[2,i.value];l.label=8;case 8:if(n.url&&r<MAX_REDIRECTS)return[3,6];l.label=9;case 9:if(r===MAX_REDIRECTS&&n.url)throw Error("Negotiate redirection limit exceeded.");return[4,this.createTransport(e,this.options.transport,n,t)];case 10:l.sent(),l.label=11;case 11:return this.transport instanceof LongPollingTransport&&(this.features.inherentKeepAlive=!0),this.transport.onreceive=this.onreceive,this.transport.onclose=function(t){return c.stopConnection(t)},this.changeState(0,1),[3,13];case 12:throw a=l.sent(),this.logger.log(LogLevel.Error,"Failed to start the connection: "+a),this.connectionState=2,this.transport=null,a;case 13:return[2]}}))}))},t.prototype.getNegotiationResponse=function(t){return __awaiter(this,void 0,void 0,(function(){var e,n,r,o,s,i;return __generator(this,(function(a){switch(a.label){case 0:return[4,this.accessTokenFactory()];case 1:(n=a.sent())&&((e={}).Authorization="Bearer "+n,r=e),o=this.resolveNegotiateUrl(t),this.logger.log(LogLevel.Debug,"Sending negotiation request: "+o),a.label=2;case 2:return a.trys.push([2,4,,5]),[4,this.httpClient.post(o,{content:"",headers:r})];case 3:if(200!==(s=a.sent()).statusCode)throw Error("Unexpected status code returned from negotiate "+s.statusCode);return[2,JSON.parse(s.content)];case 4:throw i=a.sent(),this.logger.log(LogLevel.Error,"Failed to complete negotiation with the server: "+i),i;case 5:return[2]}}))}))},t.prototype.createConnectUrl=function(t,e){return t+(-1===t.indexOf("?")?"?":"&")+"id="+e},t.prototype.createTransport=function(t,e,n,r){return __awaiter(this,void 0,void 0,(function(){var o,s,i,a,c,l,p;return __generator(this,(function(u){switch(u.label){case 0:return o=this.createConnectUrl(t,n.connectionId),this.isITransport(e)?(this.logger.log(LogLevel.Debug,"Connection was provided an instance of ITransport, using that directly."),this.transport=e,[4,this.transport.connect(o,r)]):[3,2];case 1:return u.sent(),this.changeState(0,1),[2];case 2:s=n.availableTransports,i=0,a=s,u.label=3;case 3:return i<a.length?(c=a[i],this.connectionState=0,"number"!=typeof(l=this.resolveTransport(c,e,r))?[3,8]:(this.transport=this.constructTransport(l),null!==n.connectionId?[3,5]:[4,this.getNegotiationResponse(t)])):[3,9];case 4:n=u.sent(),o=this.createConnectUrl(t,n.connectionId),u.label=5;case 5:return u.trys.push([5,7,,8]),[4,this.transport.connect(o,r)];case 6:return u.sent(),this.changeState(0,1),[2];case 7:return p=u.sent(),this.logger.log(LogLevel.Error,"Failed to start the transport '"+HttpTransportType[l]+"': "+p),this.connectionState=2,n.connectionId=null,[3,8];case 8:return i++,[3,3];case 9:throw new Error("Unable to initialize any of the available transports.")}}))}))},t.prototype.constructTransport=function(t){switch(t){case HttpTransportType.WebSockets:return new WebSocketTransport(this.accessTokenFactory,this.logger,this.options.logMessageContent);case HttpTransportType.ServerSentEvents:return new ServerSentEventsTransport(this.httpClient,this.accessTokenFactory,this.logger,this.options.logMessageContent);case HttpTransportType.LongPolling:return new LongPollingTransport(this.httpClient,this.accessTokenFactory,this.logger,this.options.logMessageContent);default:throw new Error("Unknown transport: "+t+".")}},t.prototype.resolveTransport=function(t,e,n){var r=HttpTransportType[t.transport];if(null==r)this.logger.log(LogLevel.Debug,"Skipping transport '"+t.transport+"' because it is not supported by this client.");else{var o=t.transferFormats.map((function(t){return TransferFormat[t]}));if(transportMatches(e,r))if(o.indexOf(n)>=0){if(!(r===HttpTransportType.WebSockets&&"undefined"==typeof WebSocket||r===HttpTransportType.ServerSentEvents&&"undefined"==typeof EventSource))return this.logger.log(LogLevel.Debug,"Selecting transport '"+HttpTransportType[r]+"'"),r;this.logger.log(LogLevel.Debug,"Skipping transport '"+HttpTransportType[r]+"' because it is not supported in your environment.'")}else this.logger.log(LogLevel.Debug,"Skipping transport '"+HttpTransportType[r]+"' because it does not support the requested transfer format '"+TransferFormat[n]+"'.");else this.logger.log(LogLevel.Debug,"Skipping transport '"+HttpTransportType[r]+"' because it was disabled by the client.")}return null},t.prototype.isITransport=function(t){return t&&"object"==typeof t&&"connect"in t},t.prototype.changeState=function(t,e){return this.connectionState===t&&(this.connectionState=e,!0)},t.prototype.stopConnection=function(t){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(e){return this.transport=null,(t=this.stopError||t)?this.logger.log(LogLevel.Error,"Connection disconnected with error '"+t+"'."):this.logger.log(LogLevel.Information,"Connection disconnected."),this.connectionState=2,this.onclose&&this.onclose(t),[2]}))}))},t.prototype.resolveUrl=function(t){if(0===t.lastIndexOf("https://",0)||0===t.lastIndexOf("http://",0))return t;if("undefined"==typeof window||!window||!window.document)throw new Error("Cannot resolve '"+t+"'.");var e=window.document.createElement("a");return e.href=t,this.logger.log(LogLevel.Information,"Normalizing '"+t+"' to '"+e.href+"'."),e.href},t.prototype.resolveNegotiateUrl=function(t){var e=t.indexOf("?"),n=t.substring(0,-1===e?t.length:e);return"/"!==n[n.length-1]&&(n+="/"),n+="negotiate",n+=-1===e?"":t.substring(e)},t}();export{HttpConnection};function transportMatches(t,e){return!t||0!=(e&t)}
//# sourceMappingURL=/sm/f8e3472bef100c45500dcd488a89b53d67aabb498d8ac84c03122cb3f32d199d.map