/**
 * Minified by jsDelivr using Terser v5.3.5.
 * Original file: /npm/@aspnet/signalr@1.0.27/dist/cjs/HttpConnection.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
"use strict";var __awaiter=this&&this.__awaiter||function(t,e,r,n){return new(r||(r=Promise))((function(o,s){function i(t){try{c(n.next(t))}catch(t){s(t)}}function a(t){try{c(n.throw(t))}catch(t){s(t)}}function c(t){t.done?o(t.value):new r((function(e){e(t.value)})).then(i,a)}c((n=n.apply(t,e||[])).next())}))},__generator=this&&this.__generator||function(t,e){var r,n,o,s,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(s){return function(a){return function(s){if(r)throw new TypeError("Generator is already executing.");for(;i;)try{if(r=1,n&&(o=2&s[0]?n.return:s[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,s[1])).done)return o;switch(n=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return i.label++,{value:s[1],done:!1};case 5:i.label++,n=s[1],s=[0];continue;case 7:s=i.ops.pop(),i.trys.pop();continue;default:if(!(o=i.trys,(o=o.length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){i=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){i.label=s[1];break}if(6===s[0]&&i.label<o[1]){i.label=o[1],o=s;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(s);break}o[2]&&i.ops.pop(),i.trys.pop();continue}s=e.call(t,i)}catch(t){s=[6,t],n=0}finally{r=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}};Object.defineProperty(exports,"__esModule",{value:!0});var HttpClient_1=require("./HttpClient"),ILogger_1=require("./ILogger"),ITransport_1=require("./ITransport"),LongPollingTransport_1=require("./LongPollingTransport"),ServerSentEventsTransport_1=require("./ServerSentEventsTransport"),Utils_1=require("./Utils"),WebSocketTransport_1=require("./WebSocketTransport"),MAX_REDIRECTS=100,HttpConnection=function(){function t(t,e){void 0===e&&(e={}),this.features={},Utils_1.Arg.isRequired(t,"url"),this.logger=Utils_1.createLogger(e.logger),this.baseUrl=this.resolveUrl(t),(e=e||{}).accessTokenFactory=e.accessTokenFactory||function(){return null},e.logMessageContent=e.logMessageContent||!1,this.httpClient=e.httpClient||new HttpClient_1.DefaultHttpClient(this.logger),this.connectionState=2,this.options=e}return t.prototype.start=function(t){return t=t||ITransport_1.TransferFormat.Binary,Utils_1.Arg.isIn(t,ITransport_1.TransferFormat,"transferFormat"),this.logger.log(ILogger_1.LogLevel.Debug,"Starting connection with transfer format '"+ITransport_1.TransferFormat[t]+"'."),2!==this.connectionState?Promise.reject(new Error("Cannot start a connection that is not in the 'Disconnected' state.")):(this.connectionState=0,this.startPromise=this.startInternal(t),this.startPromise)},t.prototype.send=function(t){if(1!==this.connectionState)throw new Error("Cannot send data if the connection is not in the 'Connected' State.");return this.transport.send(t)},t.prototype.stop=function(t){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(e){switch(e.label){case 0:this.connectionState=2,e.label=1;case 1:return e.trys.push([1,3,,4]),[4,this.startPromise];case 2:return e.sent(),[3,4];case 3:return e.sent(),[3,4];case 4:return this.transport?(this.stopError=t,[4,this.transport.stop()]):[3,6];case 5:e.sent(),this.transport=null,e.label=6;case 6:return[2]}}))}))},t.prototype.startInternal=function(t){return __awaiter(this,void 0,void 0,(function(){var e,r,n,o,s,i,a,c=this;return __generator(this,(function(p){switch(p.label){case 0:e=this.baseUrl,this.accessTokenFactory=this.options.accessTokenFactory,p.label=1;case 1:return p.trys.push([1,12,,13]),this.options.skipNegotiation?this.options.transport!==ITransport_1.HttpTransportType.WebSockets?[3,3]:(this.transport=this.constructTransport(ITransport_1.HttpTransportType.WebSockets),[4,this.transport.connect(e,t)]):[3,5];case 2:return p.sent(),[3,4];case 3:throw Error("Negotiation can only be skipped when using the WebSocket transport directly.");case 4:return[3,11];case 5:r=null,n=0,o=function(){var t;return __generator(this,(function(o){switch(o.label){case 0:return[4,s.getNegotiationResponse(e)];case 1:return r=o.sent(),2===s.connectionState?[2,{value:void 0}]:(r.url&&(e=r.url),r.accessToken&&(t=r.accessToken,s.accessTokenFactory=function(){return t}),n++,[2])}}))},s=this,p.label=6;case 6:return[5,o()];case 7:if("object"==typeof(i=p.sent()))return[2,i.value];p.label=8;case 8:if(r.url&&n<MAX_REDIRECTS)return[3,6];p.label=9;case 9:if(n===MAX_REDIRECTS&&r.url)throw Error("Negotiate redirection limit exceeded.");return[4,this.createTransport(e,this.options.transport,r,t)];case 10:p.sent(),p.label=11;case 11:return this.transport instanceof LongPollingTransport_1.LongPollingTransport&&(this.features.inherentKeepAlive=!0),this.transport.onreceive=this.onreceive,this.transport.onclose=function(t){return c.stopConnection(t)},this.changeState(0,1),[3,13];case 12:throw a=p.sent(),this.logger.log(ILogger_1.LogLevel.Error,"Failed to start the connection: "+a),this.connectionState=2,this.transport=null,a;case 13:return[2]}}))}))},t.prototype.getNegotiationResponse=function(t){return __awaiter(this,void 0,void 0,(function(){var e,r,n,o,s,i;return __generator(this,(function(a){switch(a.label){case 0:return[4,this.accessTokenFactory()];case 1:(r=a.sent())&&((e={}).Authorization="Bearer "+r,n=e),o=this.resolveNegotiateUrl(t),this.logger.log(ILogger_1.LogLevel.Debug,"Sending negotiation request: "+o),a.label=2;case 2:return a.trys.push([2,4,,5]),[4,this.httpClient.post(o,{content:"",headers:n})];case 3:if(200!==(s=a.sent()).statusCode)throw Error("Unexpected status code returned from negotiate "+s.statusCode);return[2,JSON.parse(s.content)];case 4:throw i=a.sent(),this.logger.log(ILogger_1.LogLevel.Error,"Failed to complete negotiation with the server: "+i),i;case 5:return[2]}}))}))},t.prototype.createConnectUrl=function(t,e){return t+(-1===t.indexOf("?")?"?":"&")+"id="+e},t.prototype.createTransport=function(t,e,r,n){return __awaiter(this,void 0,void 0,(function(){var o,s,i,a,c,p,l;return __generator(this,(function(u){switch(u.label){case 0:return o=this.createConnectUrl(t,r.connectionId),this.isITransport(e)?(this.logger.log(ILogger_1.LogLevel.Debug,"Connection was provided an instance of ITransport, using that directly."),this.transport=e,[4,this.transport.connect(o,n)]):[3,2];case 1:return u.sent(),this.changeState(0,1),[2];case 2:s=r.availableTransports,i=0,a=s,u.label=3;case 3:return i<a.length?(c=a[i],this.connectionState=0,"number"!=typeof(p=this.resolveTransport(c,e,n))?[3,8]:(this.transport=this.constructTransport(p),null!==r.connectionId?[3,5]:[4,this.getNegotiationResponse(t)])):[3,9];case 4:r=u.sent(),o=this.createConnectUrl(t,r.connectionId),u.label=5;case 5:return u.trys.push([5,7,,8]),[4,this.transport.connect(o,n)];case 6:return u.sent(),this.changeState(0,1),[2];case 7:return l=u.sent(),this.logger.log(ILogger_1.LogLevel.Error,"Failed to start the transport '"+ITransport_1.HttpTransportType[p]+"': "+l),this.connectionState=2,r.connectionId=null,[3,8];case 8:return i++,[3,3];case 9:throw new Error("Unable to initialize any of the available transports.")}}))}))},t.prototype.constructTransport=function(t){switch(t){case ITransport_1.HttpTransportType.WebSockets:return new WebSocketTransport_1.WebSocketTransport(this.accessTokenFactory,this.logger,this.options.logMessageContent);case ITransport_1.HttpTransportType.ServerSentEvents:return new ServerSentEventsTransport_1.ServerSentEventsTransport(this.httpClient,this.accessTokenFactory,this.logger,this.options.logMessageContent);case ITransport_1.HttpTransportType.LongPolling:return new LongPollingTransport_1.LongPollingTransport(this.httpClient,this.accessTokenFactory,this.logger,this.options.logMessageContent);default:throw new Error("Unknown transport: "+t+".")}},t.prototype.resolveTransport=function(t,e,r){var n=ITransport_1.HttpTransportType[t.transport];if(null==n)this.logger.log(ILogger_1.LogLevel.Debug,"Skipping transport '"+t.transport+"' because it is not supported by this client.");else{var o=t.transferFormats.map((function(t){return ITransport_1.TransferFormat[t]}));if(transportMatches(e,n))if(o.indexOf(r)>=0){if(!(n===ITransport_1.HttpTransportType.WebSockets&&"undefined"==typeof WebSocket||n===ITransport_1.HttpTransportType.ServerSentEvents&&"undefined"==typeof EventSource))return this.logger.log(ILogger_1.LogLevel.Debug,"Selecting transport '"+ITransport_1.HttpTransportType[n]+"'"),n;this.logger.log(ILogger_1.LogLevel.Debug,"Skipping transport '"+ITransport_1.HttpTransportType[n]+"' because it is not supported in your environment.'")}else this.logger.log(ILogger_1.LogLevel.Debug,"Skipping transport '"+ITransport_1.HttpTransportType[n]+"' because it does not support the requested transfer format '"+ITransport_1.TransferFormat[r]+"'.");else this.logger.log(ILogger_1.LogLevel.Debug,"Skipping transport '"+ITransport_1.HttpTransportType[n]+"' because it was disabled by the client.")}return null},t.prototype.isITransport=function(t){return t&&"object"==typeof t&&"connect"in t},t.prototype.changeState=function(t,e){return this.connectionState===t&&(this.connectionState=e,!0)},t.prototype.stopConnection=function(t){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(e){return this.transport=null,(t=this.stopError||t)?this.logger.log(ILogger_1.LogLevel.Error,"Connection disconnected with error '"+t+"'."):this.logger.log(ILogger_1.LogLevel.Information,"Connection disconnected."),this.connectionState=2,this.onclose&&this.onclose(t),[2]}))}))},t.prototype.resolveUrl=function(t){if(0===t.lastIndexOf("https://",0)||0===t.lastIndexOf("http://",0))return t;if("undefined"==typeof window||!window||!window.document)throw new Error("Cannot resolve '"+t+"'.");var e=window.document.createElement("a");return e.href=t,this.logger.log(ILogger_1.LogLevel.Information,"Normalizing '"+t+"' to '"+e.href+"'."),e.href},t.prototype.resolveNegotiateUrl=function(t){var e=t.indexOf("?"),r=t.substring(0,-1===e?t.length:e);return"/"!==r[r.length-1]&&(r+="/"),r+="negotiate",r+=-1===e?"":t.substring(e)},t}();function transportMatches(t,e){return!t||0!=(e&t)}exports.HttpConnection=HttpConnection;
//# sourceMappingURL=/sm/c27cbc3b7d98b4e2dfa6f0c4508c7ea079be7ebe6058da4d1bff4d20ef17b627.map