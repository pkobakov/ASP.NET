/**
 * Minified by jsDelivr using Terser v5.3.5.
 * Original file: /npm/@aspnet/signalr@1.0.27/dist/cjs/HubConnection.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
"use strict";var __awaiter=this&&this.__awaiter||function(e,o,t,n){return new(t||(t=Promise))((function(r,i){function s(e){try{a(n.next(e))}catch(e){i(e)}}function c(e){try{a(n.throw(e))}catch(e){i(e)}}function a(e){e.done?r(e.value):new t((function(o){o(e.value)})).then(s,c)}a((n=n.apply(e,o||[])).next())}))},__generator=this&&this.__generator||function(e,o){var t,n,r,i,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return i={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function c(i){return function(c){return function(i){if(t)throw new TypeError("Generator is already executing.");for(;s;)try{if(t=1,n&&(r=2&i[0]?n.return:i[0]?n.throw||((r=n.return)&&r.call(n),0):n.next)&&!(r=r.call(n,i[1])).done)return r;switch(n=0,r&&(i=[2&i[0],r.value]),i[0]){case 0:case 1:r=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,n=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(r=s.trys,(r=r.length>0&&r[r.length-1])||6!==i[0]&&2!==i[0])){s=0;continue}if(3===i[0]&&(!r||i[1]>r[0]&&i[1]<r[3])){s.label=i[1];break}if(6===i[0]&&s.label<r[1]){s.label=r[1],r=i;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(i);break}r[2]&&s.ops.pop(),s.trys.pop();continue}i=o.call(e,s)}catch(e){i=[6,e],n=0}finally{t=r=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,c])}}};Object.defineProperty(exports,"__esModule",{value:!0});var HandshakeProtocol_1=require("./HandshakeProtocol"),IHubProtocol_1=require("./IHubProtocol"),ILogger_1=require("./ILogger"),Utils_1=require("./Utils"),DEFAULT_TIMEOUT_IN_MS=3e4,HubConnection=function(){function e(e,o,t){var n=this;Utils_1.Arg.isRequired(e,"connection"),Utils_1.Arg.isRequired(o,"logger"),Utils_1.Arg.isRequired(t,"protocol"),this.serverTimeoutInMilliseconds=DEFAULT_TIMEOUT_IN_MS,this.logger=o,this.protocol=t,this.connection=e,this.handshakeProtocol=new HandshakeProtocol_1.HandshakeProtocol,this.connection.onreceive=function(e){return n.processIncomingData(e)},this.connection.onclose=function(e){return n.connectionClosed(e)},this.callbacks={},this.methods={},this.closedCallbacks=[],this.id=0}return e.create=function(o,t,n){return new e(o,t,n)},e.prototype.start=function(){return __awaiter(this,void 0,void 0,(function(){var e;return __generator(this,(function(o){switch(o.label){case 0:return e={protocol:this.protocol.name,version:this.protocol.version},this.logger.log(ILogger_1.LogLevel.Debug,"Starting HubConnection."),this.receivedHandshakeResponse=!1,[4,this.connection.start(this.protocol.transferFormat)];case 1:return o.sent(),this.logger.log(ILogger_1.LogLevel.Debug,"Sending handshake request."),[4,this.connection.send(this.handshakeProtocol.writeHandshakeRequest(e))];case 2:return o.sent(),this.logger.log(ILogger_1.LogLevel.Information,"Using HubProtocol '"+this.protocol.name+"'."),this.cleanupTimeout(),this.configureTimeout(),[2]}}))}))},e.prototype.stop=function(){return this.logger.log(ILogger_1.LogLevel.Debug,"Stopping HubConnection."),this.cleanupTimeout(),this.connection.stop()},e.prototype.stream=function(e){for(var o=this,t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];var r=this.createStreamInvocation(e,t),i=new Utils_1.Subject((function(){var e=o.createCancelInvocation(r.invocationId),t=o.protocol.writeMessage(e);return delete o.callbacks[r.invocationId],o.connection.send(t)}));this.callbacks[r.invocationId]=function(e,o){o?i.error(o):e.type===IHubProtocol_1.MessageType.Completion?e.error?i.error(new Error(e.error)):i.complete():i.next(e.item)};var s=this.protocol.writeMessage(r);return this.connection.send(s).catch((function(e){i.error(e),delete o.callbacks[r.invocationId]})),i},e.prototype.send=function(e){for(var o=[],t=1;t<arguments.length;t++)o[t-1]=arguments[t];var n=this.createInvocation(e,o,!0),r=this.protocol.writeMessage(n);return this.connection.send(r)},e.prototype.invoke=function(e){for(var o=this,t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];var r=this.createInvocation(e,t,!1),i=new Promise((function(e,t){o.callbacks[r.invocationId]=function(o,n){if(n)t(n);else if(o.type===IHubProtocol_1.MessageType.Completion){var r=o;r.error?t(new Error(r.error)):e(r.result)}else t(new Error("Unexpected message type: "+o.type))};var n=o.protocol.writeMessage(r);o.connection.send(n).catch((function(e){t(e),delete o.callbacks[r.invocationId]}))}));return i},e.prototype.on=function(e,o){e&&o&&(e=e.toLowerCase(),this.methods[e]||(this.methods[e]=[]),-1===this.methods[e].indexOf(o)&&this.methods[e].push(o))},e.prototype.off=function(e,o){if(e){e=e.toLowerCase();var t=this.methods[e];if(t)if(o){var n=t.indexOf(o);-1!==n&&(t.splice(n,1),0===t.length&&delete this.methods[e])}else delete this.methods[e]}},e.prototype.onclose=function(e){e&&this.closedCallbacks.push(e)},e.prototype.processIncomingData=function(e){if(this.cleanupTimeout(),this.receivedHandshakeResponse||(e=this.processHandshakeResponse(e),this.receivedHandshakeResponse=!0),e)for(var o=0,t=this.protocol.parseMessages(e,this.logger);o<t.length;o++){var n=t[o];switch(n.type){case IHubProtocol_1.MessageType.Invocation:this.invokeClientMethod(n);break;case IHubProtocol_1.MessageType.StreamItem:case IHubProtocol_1.MessageType.Completion:var r=this.callbacks[n.invocationId];null!=r&&(n.type===IHubProtocol_1.MessageType.Completion&&delete this.callbacks[n.invocationId],r(n));break;case IHubProtocol_1.MessageType.Ping:break;case IHubProtocol_1.MessageType.Close:this.logger.log(ILogger_1.LogLevel.Information,"Close message received from server."),this.connection.stop(n.error?new Error("Server returned an error on close: "+n.error):null);break;default:this.logger.log(ILogger_1.LogLevel.Warning,"Invalid message type: "+n.type)}}this.configureTimeout()},e.prototype.processHandshakeResponse=function(e){var o,t,n;try{n=(o=this.handshakeProtocol.parseHandshakeResponse(e))[0],t=o[1]}catch(e){var r="Error parsing handshake response: "+e;this.logger.log(ILogger_1.LogLevel.Error,r);var i=new Error(r);throw this.connection.stop(i),i}if(t.error){r="Server returned handshake error: "+t.error;this.logger.log(ILogger_1.LogLevel.Error,r),this.connection.stop(new Error(r))}else this.logger.log(ILogger_1.LogLevel.Debug,"Server handshake complete.");return n},e.prototype.configureTimeout=function(){var e=this;this.connection.features&&this.connection.features.inherentKeepAlive||(this.timeoutHandle=setTimeout((function(){return e.serverTimeout()}),this.serverTimeoutInMilliseconds))},e.prototype.serverTimeout=function(){this.connection.stop(new Error("Server timeout elapsed without receiving a message from the server."))},e.prototype.invokeClientMethod=function(e){var o=this,t=this.methods[e.target.toLowerCase()];if(t){if(t.forEach((function(t){return t.apply(o,e.arguments)})),e.invocationId){var n="Server requested a response, which is not supported in this version of the client.";this.logger.log(ILogger_1.LogLevel.Error,n),this.connection.stop(new Error(n))}}else this.logger.log(ILogger_1.LogLevel.Warning,"No client method with the name '"+e.target+"' found.")},e.prototype.connectionClosed=function(e){var o=this,t=this.callbacks;this.callbacks={},Object.keys(t).forEach((function(o){(0,t[o])(void 0,e||new Error("Invocation canceled due to connection being closed."))})),this.cleanupTimeout(),this.closedCallbacks.forEach((function(t){return t.apply(o,[e])}))},e.prototype.cleanupTimeout=function(){this.timeoutHandle&&clearTimeout(this.timeoutHandle)},e.prototype.createInvocation=function(e,o,t){if(t)return{arguments:o,target:e,type:IHubProtocol_1.MessageType.Invocation};var n=this.id;return this.id++,{arguments:o,invocationId:n.toString(),target:e,type:IHubProtocol_1.MessageType.Invocation}},e.prototype.createStreamInvocation=function(e,o){var t=this.id;return this.id++,{arguments:o,invocationId:t.toString(),target:e,type:IHubProtocol_1.MessageType.StreamInvocation}},e.prototype.createCancelInvocation=function(e){return{invocationId:e,type:IHubProtocol_1.MessageType.CancelInvocation}},e}();exports.HubConnection=HubConnection;
//# sourceMappingURL=/sm/ee61bb30d5a5d03308d4bc324071c40e770acb4083e0ebbd325883e670061554.map